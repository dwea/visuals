<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enhanced Human Body Pathway Explorer</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      margin: 0; 
      padding: 20px;
      background: #f8f9fa;
    }
    
    .container {
      display: grid;
      grid-template-columns: 250px 1fr 350px;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .panel {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    h1 { 
      text-align: center; 
      margin-bottom: 30px; 
      color: #2c3e50;
      grid-column: 1 / -1;
    }
    
    h3 { 
      margin-top: 0; 
      color: #34495e;
      border-bottom: 2px solid #ecf0f1;
      padding-bottom: 10px;
    }
    
    svg { 
      border-radius: 8px;
      background: #fefefe;
    }
    
    #bodymap { 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .node-group {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .node-rect {
      stroke: #fff; 
      stroke-width: 2px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      transition: all 0.2s ease;
    }
    
    .node-group:hover .node-rect {
      stroke-width: 3px;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
    }
    
    .node-group.selected .node-rect {
      stroke-width: 4px;
      stroke: #2c3e50;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }
    
    .node-text {
      font-size: 11px;
      font-weight: bold;
      fill: white;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.7);
      pointer-events: none;
      text-anchor: middle;
      dominant-baseline: middle;
    }
    
    .link { 
      stroke: #999; 
      stroke-opacity: 0.4;
      stroke-width: 2px;
      transition: all 0.3s ease;
    }
    
    .link.selected {
      stroke-opacity: 1;
      stroke-width: 4px;
    }
    
    .link.directional {
      stroke-dasharray: 8 4;
      animation: marching-ants 1s linear infinite;
    }
    
    .link.bidirectional {
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes marching-ants {
      0% { stroke-dashoffset: 0; }
      100% { stroke-dashoffset: 12; }
    }
    
    @keyframes pulse {
      0%, 100% { stroke-opacity: 0.6; }
      50% { stroke-opacity: 1; }
    }
    
    .cluster-hull {
      fill: none;
      stroke-width: 2px;
      stroke-dasharray: 5,5;
      opacity: 0.6;
      pointer-events: none;
    }
    
    .category { 
      cursor: pointer; 
      opacity: 0.7;
      transition: all 0.3s ease;
      stroke: #333;
      stroke-width: 1;
    }
    
    .category:hover { 
      opacity: 1;
      stroke-width: 2;
      filter: brightness(1.1);
    }
    
    .category.active {
      opacity: 1;
      stroke-width: 3;
      filter: drop-shadow(0 0 6px rgba(0,0,0,0.3));
    }
    
    .control-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      transition: background 0.3s ease;
      font-size: 12px;
    }
    
    .control-btn:hover {
      background: #2980b9;
    }
    
    .biomarker-item {
      background: #ecf0f1;
      margin: 5px 0;
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 4px solid #3498db;
      font-size: 13px;
      transition: all 0.2s ease;
    }
    
    .biomarker-item:hover {
      background: #d5dbdb;
      transform: translateX(2px);
    }
    
    .pathway-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 4px solid #27ae60;
    }
    
    .search-box {
      width: 100%;
      padding: 10px;
      border: 1px solid #bdc3c7;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .legend {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }
    
    .stats {
      background: #f1f2f6;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 12px;
      color: #57606f;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Enhanced Human Body Pathway Explorer</h1>
    
    <!-- Body Map Panel -->
    <div class="panel">
      <h3>Body Systems</h3>
      <svg id="bodymap" width="200" height="500">
        <!-- Enhanced body representation -->
        <circle cx="100" cy="40" r="25" fill="#8e44ad" class="category" data-cat="Cellular Regulation"></circle>
        <text x="100" y="45" text-anchor="middle" fill="white" font-size="8">Brain</text>
        
        <rect x="85" y="80" width="30" height="60" fill="#e74c3c" class="category" data-cat="Immune Response"></rect>
        <text x="100" y="105" text-anchor="middle" fill="white" font-size="8">Heart</text>
        
        <rect x="75" y="160" width="50" height="40" fill="#27ae60" class="category" data-cat="Lipid & Transport"></rect>
        <text x="100" y="180" text-anchor="middle" fill="white" font-size="8">Liver</text>
        
        <rect x="80" y="220" width="40" height="50" fill="#3498db" class="category" data-cat="Protein Processing"></rect>
        <text x="100" y="245" text-anchor="middle" fill="white" font-size="8">Kidneys</text>
        
        <rect x="70" y="290" width="60" height="80" fill="#f39c12" class="category" data-cat="Energy Metabolism"></rect>
        <text x="100" y="330" text-anchor="middle" fill="white" font-size="8">Digestive</text>
      </svg>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background: #8e44ad;"></div>
          <span>Cellular Regulation</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #e74c3c;"></div>
          <span>Immune Response</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #27ae60;"></div>
          <span>Lipid & Transport</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #3498db;"></div>
          <span>Protein Processing</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #f39c12;"></div>
          <span>Energy Metabolism</span>
        </div>
      </div>
      
      <button class="control-btn" id="cluster">Toggle Cluster View</button>
    </div>

    <!-- Force Diagram Panel -->
    <div class="panel">
      <h3>Pathway Network</h3>
      <input type="text" class="search-box" id="search" placeholder="Search pathways or biomarkers...">
      <svg id="network" width="500" height="500"></svg>
      <div class="stats" id="stats">
        Click on pathways to explore connections
      </div>
    </div>

    <!-- Biomarkers Panel -->
    <div class="panel">
      <h3>Biomarkers & Details</h3>
      <div id="biomarker-content">
        <p style="color: #7f8c8d; font-style: italic;">Click on a pathway to view biomarkers and detailed information.</p>
      </div>
    </div>
  </div>

  <script>
    // Enhanced data structure with more details
    const categories = {
      "Energy Metabolism": ["Glycolysis-gluconeogenesis cycle", "Krebs cycle", "Beta-oxidation of fatty acids"],
      "Lipid & Transport": ["Lipid metabolism and transport", "Hormone binding and transport"],
      "Immune Response": ["Acute-phase protein response", "Complement cascade", "Coagulation pathway"],
      "Protein Processing": ["Protein metabolism", "Urea cycle"],
      "Cellular Regulation": ["Oxidative stress", "Neurotransmitter metabolism"]
    };

    const categoryColors = {
      "Energy Metabolism": "#f39c12",
      "Lipid & Transport": "#27ae60",
      "Immune Response": "#e74c3c",
      "Protein Processing": "#3498db",
      "Cellular Regulation": "#8e44ad"
    };

    // Directional relationships based on biological flow
    const directionalConnections = {
      "Glycolysis-gluconeogenesis cycle → Krebs cycle": true,
      "Krebs cycle → Beta-oxidation of fatty acids": false, // bidirectional
      "Beta-oxidation of fatty acids → Lipid metabolism and transport": true,
      "Acute-phase protein response → Coagulation pathway": true,
      "Acute-phase protein response → Complement cascade": true,
      "Hormone binding and transport → Lipid metabolism and transport": false,
      "Protein metabolism → Urea cycle": true,
      "Neurotransmitter metabolism → Protein metabolism": false,
      "Oxidative stress → Acute-phase protein response": true,
      "Glycolysis-gluconeogenesis cycle → Oxidative stress": false
    };

    // Enhanced links with connection strength and directionality
    const links = [
      { source: "Glycolysis-gluconeogenesis cycle", target: "Krebs cycle", strength: "strong", directional: true },
      { source: "Krebs cycle", target: "Beta-oxidation of fatty acids", strength: "medium", directional: false },
      { source: "Beta-oxidation of fatty acids", target: "Lipid metabolism and transport", strength: "strong", directional: true },
      { source: "Acute-phase protein response", target: "Coagulation pathway", strength: "strong", directional: true },
      { source: "Acute-phase protein response", target: "Complement cascade", strength: "medium", directional: true },
      { source: "Hormone binding and transport", target: "Lipid metabolism and transport", strength: "medium", directional: false },
      { source: "Protein metabolism", target: "Urea cycle", strength: "strong", directional: true },
      { source: "Neurotransmitter metabolism", target: "Protein metabolism", strength: "medium", directional: false },
      { source: "Oxidative stress", target: "Acute-phase protein response", strength: "strong", directional: true },
      { source: "Glycolysis-gluconeogenesis cycle", target: "Oxidative stress", strength: "medium", directional: false }
    ];

    const biomarkerMap = {
      "Acute-phase protein response": ["Serum amyloid A-4 protein", "Haptoglobin", "C-reactive protein"],
      "Beta-oxidation of fatty acids": ["Short Chain Acylcarnitines", "Octadecanoylcarnitine", "Acetyl-CoA"],
      "Coagulation pathway": ["von Willebrand Factor", "Prothrombin", "Fibrinogen"],
      "Complement cascade": ["Complement factor I", "Complement C3", "C5a", "C1q"],
      "Glycolysis-gluconeogenesis cycle": ["Pyruvic acid", "Glucose", "Lactate", "ATP"],
      "Hormone binding and transport": ["Vitamin D-binding protein", "Transthyretin", "Albumin"],
      "Krebs cycle": ["Succinic acid", "Citric acid", "α-Ketoglutarate", "NADH"],
      "Lipid metabolism and transport": ["Sphingomyeline C20:2", "Apolipoprotein E", "LDL", "HDL"],
      "Neurotransmitter metabolism": ["Homovanillic acid", "Serotonin", "Dopamine", "GABA"],
      "Oxidative stress": ["Peroxiredoxin-2", "Glutathione peroxidase 3", "Catalase", "SOD"],
      "Protein metabolism": ["Valine", "Creatine", "Urea", "Amino acids"],
      "Urea cycle": ["Ornithine", "Citrulline", "Arginine", "Carbamoyl phosphate"]
    };

    // Pathway descriptions
    const pathwayDescriptions = {
      "Acute-phase protein response": "Rapid immune response triggered by infection, inflammation, or tissue damage.",
      "Beta-oxidation of fatty acids": "Process of breaking down fatty acids to produce energy in the form of ATP.",
      "Coagulation pathway": "Complex cascade of reactions leading to blood clot formation to prevent bleeding.",
      "Complement cascade": "Immune system pathway that enhances antibody and phagocytic cell ability to clear pathogens.",
      "Glycolysis-gluconeogenesis cycle": "Central metabolic pathway converting glucose to energy or synthesizing glucose from other compounds.",
      "Hormone binding and transport": "System for carrying hormones through blood and delivering them to target tissues.",
      "Krebs cycle": "Central metabolic pathway that generates energy through oxidation of acetyl-CoA derived from carbohydrates, fats, and proteins.",
      "Lipid metabolism and transport": "Processing and movement of fats and cholesterol throughout the body.",
      "Neurotransmitter metabolism": "Synthesis, release, and breakdown of chemical messengers in the nervous system.",
      "Oxidative stress": "Imbalance between free radical production and antioxidant defenses, potentially causing cellular damage.",
      "Protein metabolism": "Breakdown and synthesis of proteins, including amino acid processing.",
      "Urea cycle": "Metabolic pathway that converts toxic ammonia to urea for safe excretion."
    };

    const pathways = Object.keys(biomarkerMap);
    let nodes = pathways.map(name => ({ 
      id: name, 
      category: getCategory(name),
      color: categoryColors[getCategory(name)] || "#95a5a6"
    }));

    function getCategory(pathway) {
      for (let [cat, paths] of Object.entries(categories)) {
        if (paths.includes(pathway)) return cat;
      }
      return "Other";
    }

    const width = 500, height = 500;
    let currentFilter = null;
    let isClusterView = false;
    let selectedNode = null;

    const svg = d3.select("#network");
    
    // More snappy simulation with stronger forces
    const simulation = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).id(d => d.id).distance(100).strength(0.8))
      .force("charge", d3.forceManyBody().strength(-800))
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force("collide", d3.forceCollide(50))
      .velocityDecay(0.6); // Increased damping for snappier movement

    // Create cluster hulls
    const hullGroup = svg.append("g").attr("class", "hulls");

    // Create link elements
    const link = svg.append("g")
      .selectAll("line")
      .data(links)
      .join("line")
      .attr("class", "link")
      .attr("stroke", d => d.strength === 'strong' ? '#e74c3c' : d.strength === 'medium' ? '#f39c12' : '#999')
      .attr("marker-end", d => d.directional ? "url(#arrowhead)" : null);

    // Add arrowhead marker for directional links
    svg.append("defs").append("marker")
      .attr("id", "arrowhead")
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 15)
      .attr("refY", 0)
      .attr("markerWidth", 6)
      .attr("markerHeight", 6)
      .attr("orient", "auto")
      .append("path")
      .attr("d", "M0,-5L10,0L0,5")
      .attr("fill", "#666");

    // Create node groups (rectangle + text as single unit)
    const nodeGroup = svg.append("g")
      .selectAll("g")
      .data(nodes)
      .join("g")
      .attr("class", "node-group")
      .call(drag(simulation))
      .on("click", handleNodeClick);

    // Add rectangles to node groups
    nodeGroup.append("rect")
      .attr("class", "node-rect")
      .attr("width", d => Math.max(120, d.id.length * 8))
      .attr("height", 40)
      .attr("rx", 8)
      .attr("ry", 8)
      .attr("fill", d => d.color)
      .attr("x", d => -Math.max(60, d.id.length * 4))
      .attr("y", -20);

    // Add text to node groups
    nodeGroup.append("text")
      .attr("class", "node-text")
      .text(d => d.id)
      .call(wrapText, 110);

    function wrapText(text, width) {
      text.each(function(d) {
        const text = d3.select(this);
        const words = d.id.split(/\s+/).reverse();
        let word;
        let line = [];
        let lineNumber = 0;
        const lineHeight = 12;
        const y = 0;
        let tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y);
        
        while (word = words.pop()) {
          line.push(word);
          tspan.text(line.join(" "));
          if (tspan.node().getComputedTextLength() > width && line.length > 1) {
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            tspan = text.append("tspan").attr("x", 0).attr("y", y + ++lineNumber * lineHeight).text(word);
          }
        }
      });
    }

    function handleNodeClick(event, d) {
      // Remove previous selection
      nodeGroup.classed("selected", false);
      link.classed("selected", false);
      link.classed("directional", false);
      link.classed("bidirectional", false);

      // Set new selection
      selectedNode = d;
      d3.select(event.currentTarget).classed("selected", true);
      
      // Get connected nodes
      const connectedNodes = getConnectedNodes(d.id);
      const connectedLinks = links.filter(l => 
        l.source.id === d.id || l.target.id === d.id
      );
      
      // Highlight connected nodes
      nodeGroup.style("opacity", n => 
        connectedNodes.includes(n.id) || n.id === d.id ? 1 : 0.2
      );
      
      // Animate connected links
      link.each(function(l) {
        if (l.source.id === d.id || l.target.id === d.id) {
          const linkEl = d3.select(this);
          linkEl.classed("selected", true);
          
          if (l.directional) {
            linkEl.classed("directional", true);
          } else {
            linkEl.classed("bidirectional", true);
          }
        }
      });

      // Center the selected node with smooth transition
      const transform = d3.zoomIdentity
        .translate(width / 2 - d.x, height / 2 - d.y)
        .scale(1);
        
      svg.transition()
        .duration(750)
        .call(
          d3.zoom().transform,
          transform
        );

      // Update biomarker display
      displayNodeDetails(d);
      updateStats(d);
    }

    function getConnectedNodes(nodeId) {
      return links
        .filter(l => l.source.id === nodeId || l.target.id === nodeId)
        .map(l => l.source.id === nodeId ? l.target.id : l.source.id);
    }

    function displayNodeDetails(d) {
      const biomarkers = biomarkerMap[d.id] || [];
      const description = pathwayDescriptions[d.id] || "No description available.";
      
      const content = `
        <div class="pathway-info">
          <h4 style="margin: 0 0 10px 0; color: ${d.color};">${d.id}</h4>
          <p style="margin: 0 0 15px 0; line-height: 1.4;">${description}</p>
          <strong>Category:</strong> ${d.category}<br>
          <strong>Biomarkers:</strong> ${biomarkers.length}
        </div>
        <div style="max-height: 300px; overflow-y: auto;">
          ${biomarkers.map(b => `<div class="biomarker-item">${b}</div>`).join("")}
        </div>
      `;
      
      d3.select("#biomarker-content").html(content);
    }

    function updateStats(selectedNode) {
      const connected = getConnectedNodes(selectedNode.id);
      const biomarkerCount = biomarkerMap[selectedNode.id]?.length || 0;
      
      d3.select("#stats").html(`
        <strong>${selectedNode.id}</strong><br>
        Connected pathways: ${connected.length}<br>
        Biomarkers: ${biomarkerCount}<br>
        Category: ${selectedNode.category}
      `);
    }

    function updateClusterHulls() {
      if (!isClusterView) {
        hullGroup.selectAll("path").remove();
        return;
      }

      const categoryNodes = {};
      nodes.forEach(n => {
        if (!categoryNodes[n.category]) categoryNodes[n.category] = [];
        categoryNodes[n.category].push([n.x, n.y]);
      });

      Object.entries(categoryNodes).forEach(([category, points]) => {
        if (points.length > 1) {
          const hull = d3.polygonHull(points);
          if (hull) {
            const path = "M" + hull.join("L") + "Z";
            
            hullGroup.selectAll(`path.hull-${category.replace(/\s+/g, '-')}`)
              .data([hull])
              .join("path")
              .attr("class", `cluster-hull hull-${category.replace(/\s+/g, '-')}`)
              .attr("d", path)
              .attr("stroke", categoryColors[category])
              .attr("fill", categoryColors[category])
              .attr("fill-opacity", 0.1);
          }
        }
      });
    }

    // Simulation tick
    simulation.on("tick", () => {
      link
        .attr("x1", d => boundX(d.source.x))
        .attr("y1", d => boundY(d.source.y))
        .attr("x2", d => boundX(d.target.x))
        .attr("y2", d => boundY(d.target.y));

      nodeGroup
        .attr("transform", d => `translate(${d.x = boundX(d.x)}, ${d.y = boundY(d.y)})`);

      updateClusterHulls();
    });

    function boundX(x) { return Math.max(60, Math.min(width - 60, x)); }
    function boundY(y) { return Math.max(30, Math.min(height - 30, y)); }

    function drag(simulation) {
      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      }
      function dragged(event, d) {
        d.fx = event.x; d.fy = event.y;
      }
      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
      }
      return d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);
    }

    // Add zoom behavior
    const zoom = d3.zoom()
      .scaleExtent([0.5, 3])
      .on("zoom", (event) => {
        const { transform } = event;
        svg.selectAll("g").attr("transform", transform);
      });

    svg.call(zoom);

    // Body region click handlers
    d3.selectAll(".category").on("click", function() {
      const cat = d3.select(this).attr("data-cat");
      currentFilter = cat;
      
      // Remove active class from all categories, add to clicked one
      d3.selectAll(".category").classed("active", false);
      d3.select(this).classed("active", true);
      
      const visible = categories[cat];
      
      nodeGroup.style("opacity", d => visible.includes(d.id) ? 1 : 0.1);
      link.style("opacity", d => 
        visible.includes(d.source.id) && visible.includes(d.target.id) ? 0.8 : 0.05
      );
      
      d3.select("#biomarker-content").html(`
        <div class="pathway-info">
          <h4 style="color: ${categoryColors[cat]};">${cat}</h4>
          <p>Pathways in this category: ${visible.join(", ")}</p>
        </div>
      `);
    });

    // Cluster toggle
    d3.select("#cluster").on("click", function() {
      isClusterView = !isClusterView;
      
      if (isClusterView) {
        // Add category-based clustering force
        simulation.force("cluster", categoryCluster());
        d3.select(this).text("Network View");
      } else {
        simulation.force("cluster", null);
        d3.select(this).text("Cluster View");
      }
      
      simulation.alpha(0.3).restart();
    });

    function categoryCluster() {
      const clusterCenters = {
        "Energy Metabolism": { x: 150, y: 350 },
        "Lipid & Transport": { x: 350, y: 150 },
        "Immune Response": { x: 150, y: 150 },
        "Protein Processing": { x: 350, y: 350 },
        "Cellular Regulation": { x: 250, y: 250 }
      };
      
      return function(alpha) {
        nodes.forEach(d => {
          const cluster = clusterCenters[d.category];
          if (cluster) {
            const dx = cluster.x - d.x;
            const dy = cluster.y - d.y;
            d.vx += dx * alpha * 0.2;
            d.vy += dy * alpha * 0.2;
          }
        });
      };
    }

    // Search functionality
    d3.select("#search").on("input", function() {
      const searchTerm = this.value.toLowerCase();
      
      if (searchTerm === "") {
        if (!currentFilter && !selectedNode) {
          nodeGroup.style("opacity", 1);
          link.style("opacity", 0.4);
        }
        return;
      }
      
      nodeGroup.style("opacity", d => {
        const pathwayMatch = d.id.toLowerCase().includes(searchTerm);
        const biomarkerMatch = biomarkerMap[d.id]?.some(b => 
          b.toLowerCase().includes(searchTerm)
        );
        return pathwayMatch || biomarkerMatch ? 1 : 0.1;
      });
      
      link.style("opacity", l => {
        const sourceVisible = l.source.id.toLowerCase().includes(searchTerm);
        const targetVisible = l.target.id.toLowerCase().includes(searchTerm);
        return sourceVisible || targetVisible ? 0.6 : 0.05;
      });
    });

    // Click outside to deselect
    svg.on("click", function(event) {
      if (event.target === this) {
        selectedNode = null;
        nodeGroup.classed("selected", false);
        nodeGroup.style("opacity", 1);
        link.classed("selected", false);
        link.classed("directional", false);
        link.classed("bidirectional", false);
        link.style("opacity", 0.4);
        
        d3.select("#biomarker-content").html(`
          <p style="color: #7f
